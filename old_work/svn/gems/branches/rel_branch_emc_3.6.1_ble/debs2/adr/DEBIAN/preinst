#!/bin/bash -x
# Run this before removing this package, it requires root privilage
source /etc/environment
if [ -d $OPT_ENLIGHTED/adr ]
then
        echo "$OPT_ENLIGHTED/ard Directory exists!!!!"
else
        echo "Creating $OPT_ENLIGHTED/adr directory"
        mkdir $OPT_ENLIGHTED/adr
fi
ADR_PATH=$OPT_ENLIGHTED/adr
DBUSER=postgres
DBHOST=localhost
DB=adr
ps -ef |grep postgresql |grep -v grep > /dev/null
if [ $? -eq 0 ]
        then
                if [ `psql -q -U ${DBUSER} -h ${DBHOST}  -t -c "select count(*) from pg_database where datname='${DB}'"` -eq 1 ]
                        then

                                mkdir -p ${ADR_PATH}/tempExtract
                                dumpfileprefix=adr_dump_preupgradebkp

                                #-- Take backup of existing war and database

                                echo "Taking backup of Existing application.."

                                sudo cp ${ADR_PATH}/adr.jar ${ADR_PATH}/tempExtract/adr_bkp.jar

                                echo "Taking backup of database.."
                                /usr/bin/pg_dump -U $DBUSER -h $DBHOST -b -f "${ADR_PATH}/tempExtract/${dumpfileprefix}.sql" $DB

				p1=`ps -eaf | grep adr.jar | grep -v grep | wc -l`
                       		if [ ${p1} -ne 0 ]
                       		then
                                	echo "Closing the existing adr.jar process!!!!"
                             		pid=`ps -eaf | grep adr.jar | grep -v grep | sed 's/ \+ /\ /g' | cut -d " " -f2`
                             		sudo kill -9 ${pid}
				fi
                                echo "Undeploying application.."
                                sudo rm -fr ${ADR_PATH}/adr.jar

                        else
                                 echo "First time install"

                fi
        else
                echo "Postgres not running. Maybe first time install"
fi

