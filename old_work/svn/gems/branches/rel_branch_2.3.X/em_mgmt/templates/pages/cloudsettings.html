{% extends "pages/layouts/mainLayout.html" %}

{% load i18n %}

{% load customtemplatetags %}

{% block body %}

<script type="text/javascript"> 

$().ready(function(){
			$("#cloudForm").validate({
				rules: {
					serverIp: {
						required: true
					}
				},
				messages: {
					serverIp: {
						required: 'Field is required',
					}
				}
			});
			
			/*jQuery.validator.addMethod("fileNameCheck", function(value, element) {
				var fullPath = value;
	            var fileArray = fullPath.split(/^.*[\\\/]/);
	            var fileName = fileArray[fileArray.length-1];
			    return this.optional(element) || /^[a-z]+.pfx$/.test(fileName);  
			    }, "Please check your file.It should be of the format .pfx");*/
			
			$("#uploadCertificateForm").validate({
				rules: {
					file: {
						required: true,
						accept: "pfx",
						//fileNameCheck: ""
					}
				},
				messages: {
					file: {
						required: "{% trans 'error.above.field.required' %}",
						accept: ".pfx extension is only allowed. Please check the selected file format."
					}
				}			
			});

			$("#file").click(function(){
				   
				   label = $('label[for="'+ $(this).attr('id') +'"]');
				   $(this).removeClass('error');
				   label.hide();
				  
			});
			
			
			{% if savestatus == "S" %}
			$("#savestatus").css("color", "green");
			$("#savestatus").html("Setup is saved successfully.");

	        {% endif %}
	        
	        {% if savestatus == "F" %}
	        $("#savestatus").css("color", "red");
			$("#savestatus").html("Setup is not saved successfully. Please try again.");
	         
	        {% endif %}
	        
	        
	        $("#serverIp").val('{{serverIpValue}}');
	        $("#emMac").val('{{emMacValue}}');
	        if('{{isCloudEnabled}}'!='0')
	        {
	        	$("#eCC").attr('checked',true);
	        }else 
	        {
	        	$("#eCC").attr('checked',false);
	        }
	        
	        
	        $(".outermostdiv").css("minHeight", $(window).height() - 85);
});

function saveCloudSettings(){
	var isValid = $('#cloudForm').valid();		
	if(isValid){
		$('#cloudForm').submit();
	}
	
}

function uploadCertificate() {		
	var isValid = $('#uploadCertificateForm').valid();		
	if(isValid) {	                
        $('#uploadsubmit').attr('disabled', 'disabled');
		$("#uploadProgressDiv").show();
		var loadingImageString = "<img alt='loading' src='{{ STATIC_URL }}static/themes/default/images/ajax-loader_small.gif'>";
		$("#uploadProgressIndicator").html("<span>" + "{% trans 'restore.upload.wait' %}" + loadingImageString + "</span><span id='uploadSizeIndicator'></span>");
        var uploadPollServer = setInterval( function() {
		 	  $.ajax({
				   type: "POST",
				   cache: false,
				   dataType: "json",
				   url: '{{ STATIC_URL }}services/upload/size/',
				   beforeSend: function() {
				   },
				   success: function(data){
			          $.each(data, function(key, val) {
			              msg = val;
			          });
				   	  if(msg != "-1") {
				   		$("#uploadSizeIndicator").text(msg);
				   	  }
				    } 
				   });
				   }, 5000);
	       	$("#uploadCertificateForm").submit();
	}
}

</script>

<div class="pgset">
<div class="outermostdiv">
	<div class="outerContainer">
		<div class="i1"></div>
    	<div style="margin-top: 15px; width:100%;">
			<fieldset style="padding: 10px;font-weight:normal;font-size: 1em;">
			<legend style="font-weight: bold">{% trans "em.cloudsettings.title" %}</legend>
			<form id="cloudForm" action="{{ STATIC_URL }}cloudsettings/save/" method="post">	
			{% csrf_token %}
			<table cellspacing="10px">
				<tr>
					<td class="formPrompt" style="font-weight:normal;font-size: 1em;">Cloud Server:</td>
					<td class="formValue"><input id="serverIp" path="serverIp" name="serverIp" class="biginput" /></td>
				</tr>
				<tr>
					<td class="formPrompt" style="font-weight:normal;font-size: 1em;">EC MAC Address:</td>
					<td class="formValue"><input id="emMac" path="emMac" readonly="true"  name="emMac" class="biginput" /></td>
				</tr>
				<tr>
					<td class="formPrompt" style="font-weight:normal;font-size: 1em;">Health Monitor Beacon:</td>
					<td class="formValue"><input  type="checkbox"  id="eCC" path="eCC"  name="eCC" class="eCC" /></td>
					
				</tr>
				<tr>
					<td class="formPrompt"><span></span></td>
					<td class="formValue"><input style="display: inline; margin-right: 10px;" id="saveCloudBtn" type="button"
						value="Save" onclick="saveCloudSettings();" /><span id="savestatus" style="font-size: 1.1em; display: inline"></span></td>
				</tr>
			</table>
			
			</form>	
			<div>
			<br/>
			<b>Instructions to Fill the Data:</b>		
			<ul style="padding-left:10px">
				<li><b>Cloud Server Domain: </b>Cloud server domain that this EC communicates to.</li>
				<li><b>EC Mac Address: </b>Mac Address for this EC.</li>
			</ul>
			</div>
			</fieldset>
			</div>
			{% if isCloudEnabled == '1' %}
			{% if cloudCommunicateTypeValue == '2' %}
			<div class="i1"></div>
			<div>
				<fieldset style="padding: 10px;">
				<legend style="font-weight: bold">Upload a certificate</legend>
				
					<form id="uploadCertificateForm" action="{{ STATIC_URL }}cloudsettings/upload/file/" method="post" enctype="multipart/form-data">
			        {% csrf_token %}
							<div class="field">
								<div class="formPrompt"><span>Certificate file to be uploaded</span></div>
								<div class="formValue">
									<input type="file" name="file" id="file" />
								</div>
							</div>
							<div id="uploadProgressDiv" class="field">
								<div class="formPrompt"><span></span></div>
								<div class="formValue" id="uploadProgressIndicator"></div>
							</div>
							<script type="text/javascript">
			          {% if uploadStatus == 'F' %}
			     	      $("#uploadProgressIndicator").html("<span style='color:red'>"+ "{% trans 'error.restore.upload.internal' %}" +"</span>");
			          {% else %} {% if uploadStatus == 'S' and fileuploadconfirmation %}
			            $("#uploadProgressIndicator").html("<span style='color:green'>" + '{{ fileuploadconfirmation }}' + "</span>");
			          {% else %}
			            $("#uploadProgressDiv").hide();
			          {% endif %} {% endif %}
							</script>
							<div class="field">
								<div class="formPrompt"><span></span></div>
								<div class="formValue">
									<input class="navigation" id="uploadsubmit" type="button" onclick="uploadCertificate();" value="{% trans 'action.upload' %}"/>
								</div>
							</div>
					  </form>
				</fieldset>
			</div>
		{% endif %}
		{% endif %}
		</div>
	</div>
</div>

{% endblock %}